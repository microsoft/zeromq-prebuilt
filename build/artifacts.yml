parameters:
  artifact_name: ''
  prebuild_folder_name: ''
  output_node_file: ''
  test: true

steps:

- bash: |
    ls -LR
  workingDirectory: zeromq.js
  displayName: List zeromq.js files

- bash: |
    node -r '$(Build.SourcesDirectory)/zeromq.js/prebuilds/${{ parameters.prebuild_folder_name }}/${{ parameters.output_node_file }}' -e 'console.log(1)'
  condition: and(succeeded(), eq(${{ parameters.test }}, true))
  displayName: Test Node Module

- task: PublishSymbols@2
  inputs:
    IndexSources: false # Unsupported source provider 'GitHub' for source indexing.
    SymbolsFolder: $(Build.SourcesDirectory)/zeromq.js
    SearchPattern: '**\*.pdb'
    SymbolServerType: TeamServices
    ArtifactServices.Symbol.AccountName: microsoft
    ArtifactServices.Symbol.PAT: $(System.AccessToken)
    ArtifactServices.Symbol.UseAAD: false
  displayName: Publish Symbols

- task: ArchiveFiles@2
  condition: and(succeeded(), eq('${{ parameters.artifact_name }}', 'linux-x64'))
  displayName: 'Archive Binary'
  inputs:
    rootFolderOrFile: '$(Build.SourcesDirectory)/zeromq.js/prebuilds/${{ parameters.prebuild_folder_name }}'
    includeRootFolder: false
    archiveType: 'tar'
    tarCompression: 'gz'
    archiveFile: '$(Build.ArtifactStagingDirectory)/${{ parameters.artifact_name }}.tar.gz'

- task: ArchiveFiles@2
  condition: and(succeeded(), not(contains('${{ parameters.artifact_name }}', 'win32')), ne('${{ parameters.artifact_name }}', 'linux-x64'))
  displayName: 'Archive Binary'
  inputs:
    rootFolderOrFile: '$(Build.SourcesDirectory)/zeromq.js/prebuilds/${{ parameters.prebuild_folder_name }}'
    includeRootFolder: false
    archiveType: 'zip'
    archiveFile: '$(Build.ArtifactStagingDirectory)/${{ parameters.artifact_name }}.zip'

- powershell:
    Compress-Archive -Path $(Build.SourcesDirectory)/zeromq.js/prebuilds/${{ parameters.prebuild_folder_name }}/${{ parameters.output_node_file }} -DestinationPath "$env:BUILD_ARTIFACTSTAGINGDIRECTORY\${env:TARGET}.zip"
  displayName: 'Archive Binary'
  condition: and(succeeded(), contains('${{ parameters.artifact_name }}', 'win32'))
  env:
    TARGET: ${{ parameters.prebuild_folder_name }}

- powershell:
    Compress-Archive -Update -Path .\zeromq.js\build\libzmq\bin\*.dll -DestinationPath "$env:BUILD_ARTIFACTSTAGINGDIRECTORY\${env:TARGET}.zip"
  displayName: 'Archive dlls'
  condition: and(succeeded(), contains('${{ parameters.artifact_name }}', 'win32'))
  env:
    TARGET: ${{ parameters.prebuild_folder_name }}
